angular.module("IndieWise.utilities",[]).factory("UtilsService",["$rootScope","$window","DataService",function($rootScope,$window,DataService){"use strict";return{compressArray:function(original){var compressed=[];var copy=original.slice(0);for(var i=0;i<original.length;i++){var myCount=0;for(var w=0;w<copy.length;w++){if(original[i]==copy[w]){myCount++;delete copy[w]}}if(myCount>0){var a=new Object;a.value=original[i];a.count=myCount;compressed.push(a)}}return compressed},recordActivity:function(object,verb){console.log("Activity Object: ",object);console.log("Activity Verb: ",verb);switch(verb){case"comment":case"reply":DataService.save("Action",{actor:angular.isString(object.author)?object.author:object.author.id,verb:verb,comment:object.id,critique:object.parentCritique.id||object.parentCritique,userIds:verb==="reply"?[object.parentCritique.author,object.author.id].toString():object.parentCritique.author});break;case"react":DataService.save("Action",{actor:object.user.id,verb:verb,reaction:object.id,project:object.project.id,userIds:angular.isString(object.user)?object.user:object.user.id});break;case"like":case"unlike":DataService.save("Action",{actor:object.author,verb:verb,rating:object.id,project:object.project,userIds:angular.isString(object.author)?object.author:object.author.id});break;case"watch":DataService.save("Action",{actor:$rootScope.AppData.User.userId,verb:verb,project:object.id,userIds:object.owner.id});break}},enrichNotifications:function(data){var unseen=0,unread=0;___.each(data.activities,function(a){a.actors=[],a.actiList=[];var actorIds=[];if(angular.isDefined(a.actor_parse)){var actor={id:a.actor_parse.id||null,name:a.actor_parse.first_name+" "+a.actor_parse.last_name};if(!___.contains(actorIds,actor.id)){a.actors.push(actor);actorIds.push(actor.id)}}if(angular.isDefined(a.object_parse)){var obj={id:a.object_parse.id,name:a.object_parse.name,"class":a.object_parse.className};a.icon="notifications";switch(a.verb){case"watch":a.icon="video_library";obj.url={state:"video",args:{id:a.object_parse.id}};break;case"judge":a.icon="grade";obj.url={state:"video_critique",args:{id:a.object_data.targets.film.id}};obj.name=a.object_data.targets.film.name;break;case"comment":case"reply":a.icon="comment";if(angular.isDefined(a.object_parse.parentComment)){a.verb="reply"}if(angular.isDefined(a.object_data.targets.film)){obj.url={state:"video",args:{id:a.object_data.targets.film.id}};obj.name=a.object_data.targets.film.name}if(angular.isDefined(a.object_data.targets.critique)){obj.url={state:"video_critique",args:{id:a.object_data.targets.critique.id}};obj.name=a.object_data.owner.name.endsWith("s")?a.object_data.owner.name+"' critique.":a.object_data.owner.name+"'s critique."}break;case"message":a.icon="comment";obj.url={state:"messages",args:{id:a.object_parse.parent.id}};break}obj.timestamp=a.object_parse.createdAt;obj.data=a.object_data;a.actiList.push(obj)}else{}if(!a.is_seen){unseen++}if(!a.is_read){unread++}a.actiList=___.uniq(a.actiList,"id")});return{data:data,unseen:unseen,unread:unread}},enrichRawNotifications:function(data){var unseen=0,unread=0;___.each(data,function(n){n.test=___.pluck(n.activities,"object_data");n.actors=[],n.objects=[],n.summary={names:""};var actorIds=[];___.each(n.activities,function(a,i){if(angular.isDefined(a.object_data)){n.icon="notifications";var obj={};switch(n.verb){case"like":n.icon="thumb_up";obj.url={state:"video",args:{id:a.object_data.targets.film.id}};break;case"unlike":n.icon="thumb_down";obj.url={state:"video",args:{id:a.object_data.targets.film.id}};break;case"watch":n.icon="video_library";obj.url={state:"video",args:{id:a.object_data.id}};break;case"react":n.icon="emotion";obj.url={state:"video",args:{id:a.object_data.targets.film.id}};break;case"judge":n.icon="grade";obj.url={state:"video_critique",args:{video_id:a.object_data.targets.film.id,id:a.object_data.id}};obj.name=a.object_data.targets.film.name;break;case"comment":case"reply":n.icon="comment";if(angular.isDefined(a.object_data.targets.comment)){n.verb="reply"}if(angular.isDefined(a.object_data.targets.film)){obj.url={state:"video",args:{id:a.object_data.targets.film.id}};obj.name=a.object_data.targets.film.name}if(angular.isDefined(a.object_data.targets.critique)){obj.url={state:"video_critique",args:{id:a.object_data.targets.critique.id}};obj.name=a.object_data.owner.name.endsWith("s")?a.object_data.owner.name+"' critique.":a.object_data.owner.name+"'s critique."}break;case"message":n.icon="comment";break}obj.timestamp=a.time;obj.data=a.object_data;n.objects.push(obj)}else{}});if(!n.is_seen){unseen++}if(!n.is_read){unread++}n.main_url=n.objects[0].url});return{data:data,unseen:unseen,unread:unread}},deleteActivity:function(object){var objectOwner=object.author||object.owner;var ownerQuery=new Parse.Query("Action");ownerQuery.equalTo("feedUserId",objectOwner.id);ownerQuery.equalTo("object",object.className+":"+object.id);var notificationQuery=new Parse.Query("Action");notificationQuery.equalTo("to","notification:"+objectOwner.id);notificationQuery.equalTo("object",object.className+":"+object.id);$rootScope.getNewToken("user","all").then(function(token){var feed=window.StreamClient.feed("user","all",token);var mainQuery=Parse.Query.or(ownerQuery,notificationQuery);mainQuery.find().then(function(res){___.each(res,function(a){var fID="ref:Action:"+a.id;console.log(fID);feed.removeActivity({foreignId:fID});a.destroy()})})})},parseJwt:function(token){var base64Url=token.split(".")[1];var base64=base64Url.replace("-","+").replace("_","/");return JSON.parse($window.atob(base64))}}}]);if(!String.prototype.endsWith){String.prototype.endsWith=function(searchString,position){var subjectString=this.toString();if(typeof position!=="number"||!isFinite(position)||Math.floor(position)!==position||position>subjectString.length){position=subjectString.length}position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position}}var AlphabeticID={index:"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",encode:function(_number){if("undefined"==typeof _number){return null}else if("number"!=typeof _number){throw new Error("Wrong parameter type")}var ret="";for(var i=Math.floor(Math.log(parseInt(_number))/Math.log(AlphabeticID.index.length));i>=0;i--){ret=ret+AlphabeticID.index.substr(Math.floor(parseInt(_number)/AlphabeticID.bcpow(AlphabeticID.index.length,i))%AlphabeticID.index.length,1)}return ret.reverse()},decode:function(_string){if("undefined"==typeof _string){return null}else if("string"!=typeof _string){throw new Error("Wrong parameter type")}var str=_string.reverse();var ret=0;for(var i=0;i<=str.length-1;i++){ret=ret+AlphabeticID.index.indexOf(str.substr(i,1))*AlphabeticID.bcpow(AlphabeticID.index.length,str.length-1-i)}return ret},bcpow:function(_a,_b){return Math.floor(Math.pow(parseFloat(_a),parseInt(_b)))}};String.prototype.reverse=function(){return this.split("").reverse().join("")};